"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),express=require("express"),user=express.Router(),us=require("../model/user"),bodyParser=require("body-parser"),path=require("path"),bcrypt=require("bcrypt"),saltRounds=10;user.use(bodyParser.urlencoded({extended:!1})),user.use(bodyParser.json());var root=path.resolve(__dirname,"..");user.get("/list",function(){var t=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r,t){return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t.sendFile(path.join(root,"views","user","list.html"));case 1:case"end":return e.stop()}},e)}));return function(e,r){return t.apply(this,arguments)}}()),user.get("/add",function(e,r){r.sendFile(path.join(root,"views","user","add.html"))}),user.get("/login",function(e,r){r.sendFile(path.join(root,"views","user","login.html"))}),user.get("/info",function(e,r){r.sendFile(path.join(root,"views","user","info.html"))}),user.get("/info",function(e,r){r.send(e.session.username)}),user.get("/userList",function(r,t){us.find().then(function(e){t.send({result:e,userInfo:{id:r.session.userid,name:r.session.name,image:r.session.image}})}).catch(function(e){console.log("查询失败"+e)})}),user.post("/addUserInfo",function(){var t=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r,t){var n,s,o,u,a,i;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.body,s=n.username,o=n.email,u=n.password,"普通用户"==(a=n.role)?a="normal":"超级管理员"==a&&(a="admin"),i="",e.next=5,bcrypt.hash(u,saltRounds).then(function(e){i=e}).catch(function(e){console.log("密码加密错误----"+e)});case 5:return e.next=7,us.create({username:s,email:o,password:i,role:a});case 7:t.redirect(301,"/user/list");case 8:case"end":return e.stop()}},e)}));return function(e,r){return t.apply(this,arguments)}}()),user.get("/stateChange",function(){var t=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(r,t){var n,s;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.query.id,s=r.query.state,console.log(s),s="true"!=s,e.next=6,us.findByIdAndUpdate({_id:n},{state:s});case 6:t.send("ok");case 7:case"end":return e.stop()}},e)}));return function(e,r){return t.apply(this,arguments)}}()),module.exports=user;